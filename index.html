<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="d3-tip.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" href="colors_icons.css">
    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
            position: relative;
            box-sizing: border-box;
            font-size: 15px;
            font-family: Roboto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .pie-total {
            font-size: 22px;
            font-weight: bold;
        }

        .pie-baloon-link {
            text-decoration: none;
            text-align: center;
            display: block;
            width: 100%;
            height: 100%;
            color: #999999;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .pie-baloon-amount {
            color: #444444;
            font-weight: bold;
            font-size: 20px;
        }

        .pie-baloon-transactions {
            color: #039be5;
        }

        .pie-label:hover {
            fill: #039be5;
            cursor: pointer;
        }

        .d3-tip {
            position: relative;
            width: 145px;
            height: 97px;
            padding: 14px 0;
            font-size: 14px;
            background-color: white;
            border: 2px solid #dddddd;
            border-radius: 8px;
            line-height: 1;
        }

        text {
            fill: #333333;
        }

        line {
            stroke: #dddddd;
        }

        /* Creates a small triangle extender for the tooltip */

        .d3-tip:after {
            content: "";
            display: inline-block;
            position: absolute;
            height: 10px;
            width: 10px;
            top: 100%;
            left: 50%;
            transform: rotate(45deg);
            transform-origin: top right;
            border-right: 2px solid #dddddd;
            border-bottom: 2px solid #dddddd;
            background-color: white;
            z-index: 2;
        }
    </style>

    <title>D3</title>

</head>

<body>

    <script>
        raw_data = [
            { "label": "Kids", "keyword": "kids", "value": 40, "transactions": 31, "parent": "" },
            { "label": "Health & fitness", "keyword": "Health & fitness", "value": 24, "transactions": 15, "parent": "" },
            { "label": "Utilities", "keyword": "Utilities","value": 5, "transactions": 9,  "parent": "" },
            { "label": "Food & drinks", "keyword": "Food & drinks","value": 45, "transactions": 31, "parent": "" },
            { "label": "Household", "keyword": "Household", "value": 10, "transactions": 9, "parent": "" },
            { "label": "Baby supplies", "keyword": "Baby supplies", "value": 30, "transactions": 31, "parent": "Kids" },
            { "label": "Babysitter daycare", "keyword": "Babysitter daycare", "value": 50, "transactions": 31, "parent": "Kids" },
            { "label": "Pharmacy", "keyword": "Pharmacy","value": 10, "transactions": 31, "parent": "Health & fitness" },
            { "label": "Medicine", "keyword": "Medicine", "value": 50, "transactions": 1, "parent": "Health & fitness" },
            { "label": "Restaurants", "keyword": "Restaurants", "value": 20, "transactions": 31, "parent": "Food & drinks" },
            { "label": "sub_category1", "keyword": "sub_category1", "value": 50, "transactions": 1, "parent": "Food & drinks" },
            { "label": "sub_category2", "keyword": "sub_category2", "value": 30, "transactions": 31, "parent": "Restaurants" },
            { "label": "sub_category3", "keyword": "sub_category3", "value": 20, "transactions": 31, "parent": "Restaurants" },
        ]

        function fetchData(raw_data, parent = '') {
            var result = [];
            temp = raw_data.filter(item => item.parent === parent);
            return temp;
        }

        var width = 500,
            height = 340,
            outerRadius = 114,
            innerRadius = 66.5,
            labelR = outerRadius + 28;

        var color = d3.scaleOrdinal(["#3f51b5", "#009688", "#039be5", "#d2d588",
            "#795548", "#ff6f00", "#e91e63", "#607d8b",
            "#7cb342", "#e53935"]);


        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        var g = svg.append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var lineG = svg.append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")

        var key = function (d) { return d.data.keyword; }

        var pie = d3.pie().value(function (d) {
            return d.value;
        });

        var pieArc = d3.arc()
            .outerRadius(outerRadius)
            .innerRadius(innerRadius);

        var lineArc1 = d3.arc()
            .outerRadius(outerRadius + 2)
            .innerRadius(outerRadius + 2);

        var lineArc2 = d3.arc()
            .outerRadius(outerRadius + 19)
            .innerRadius(outerRadius + 19);


        function change(data) {

            // calculate total value

            var totalValue = d3.sum(data, function (d) { return d.value; });

            var total = g.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", ".35em")
                .attr("class", "pie-total")
                .text(totalValue + " €");

            //calculate percent for baloon - also used to calc animation

            function calcPerc(value) {
                return Math.round(value / totalValue * 100);
            }

            // remove ballons and total when data refreshed 

            function removeNodes() {
                total.remove();
                d3.select(".d3-tip").remove();
            }

            //start making donut chart

            var newArcs = g.selectAll(".arc")
                .data(pie(data), key);


            var arcs = newArcs.enter().append("g")
                .attr("class", "arc");


            //add color to slices

            var slices = arcs.append("path")
                .attr("d", pieArc)
                .attr("fill", function (d, i) { return d.data.color || color(i); })
                .attr("stroke", "#fff")
                .attr("class", "slice");


            //add animation to slices on load
            slices.transition("load")
                .duration(function (d, i) {
                    return calcPerc(d.data.value) * 20;
                })
                .attrTween('d', function (d) {
                    var i = d3.interpolate(d.startAngle + 0.1, d.endAngle);
                    return function (t) {
                        d.endAngle = i(t);
                        return pieArc(d);
                    }
                });

            slices.on("click", function (d, i) {
                if (fetchData(raw_data, d.data.label).length) {

                    //total and baloons removed on every 'change' function call 
                    removeNodes();
                    change(fetchData(raw_data, d.data.label))

                }
            })
                .on("mouseover", function (d) {
                    if (fetchData(raw_data, d.data.label).length) {
                        var parent = d3.select(this).node().parentNode;
                        parent.style.opacity = "0.5";;
                        parent.style.cursor = "zoom-in";
                    }
                })
                .on("mouseleave", function (d) {
                    var parent = d3.select(this).node().parentNode;
                    parent.style.opacity = "1";
                    parent.style.cursor = "default";
                })

            newArcs.exit()
                .remove();

            //add icons

            var slicesWithIcons = arcs.filter(function (d, i) {
                var angle = d.endAngle - d.startAngle;

                if (d.data.icon_path && angle > 0.38) {
                    return true;
                }
                return false;
            });



            slicesWithIcons.each(function (d) {

                var self = d3.select(this);

                //inside d3.svg endAngle changes
                var endAngle = d.endAngle;

                d3.svg(d.data.icon_path, { crossOrigin: "anonymous" }).then(function (svg) {
                    var svgNode = document.importNode(svg.documentElement, true);

                        self.append(function(d) {
                            return svgNode;
                        })
                        .attr("width", 16).attr("height", 16)
                        .attr("class", "icon")
                        .attr("x", function (d) {
                            d.endAngle = endAngle;

                            var x = pieArc.centroid(d)[0] - 8;
                            return x;
                        })
                        .attr("y", function (d) {
                            var y = pieArc.centroid(d)[1] - 8;
                            return y;
                        })
                        .on("mouseover", function (d, i, nodes) {
                            if (fetchData(raw_data, d.data.label).length) {                                                                                                                                                                  
                                self.style("cursor", "zoom-in");
                                self.style("opacity","0.5");    
                            }
                        })
                        .on("click", function (d, i) {
                            if (fetchData(raw_data, d.data.label).length) {

                                removeNodes();
                                change(fetchData(raw_data, d.data.label));
                            }
                        })
                        .selectAll("path").style("fill", "#fff");

                });

            });


            // change opacity of slice when mouse over icon 

            //add baloons(tooltips) 

            var tool_tip = d3.tip()
                .attr("class", "d3-tip")
                .offset([-15, 0])
                .html(function (d) {
                    return "<a href='#' class='pie-baloon-link'><div class='pie-baloon-transactions'>" + d.data.transactions + " transactions </div>"
                        + "<div class='pie-baloon-amount'>"
                        + d.data.value + " €</div>"
                        + "<div>" + calcPerc(d.data.value) + "%</div></a>";
                });
            g.call(tool_tip);

            // hide baloons on mouseout 

            // add labels                         
            var labels = arcs.append("text")
                .attr("transform", function (d) {
                    var c = pieArc.centroid(d),
                        x = c[0],
                        y = c[1],
                        // pythagorean theorem for hypotenuse
                        h = Math.sqrt(x * x + y * y);
                    return "translate(" + (x / h * labelR) + ',' +
                        (y / h * labelR) + ")";
                })
                .attr("dy", ".35em")
                .attr("text-anchor", function (d) {
                    // are we past the center?
                    return (d.endAngle + d.startAngle) / 2 > Math.PI ?
                        "end" : "start";
                })
                .text(function (d, i) { return d.data.label; })
                .attr("class", "pie-label")

                // baloons show up on mouseover 

                .on('mouseover', function (d) {

                    tool_tip.show(d);
                    var baloon = document.querySelector(".d3-tip");

                    baloon.addEventListener('mouseleave', function (d) {
                        tool_tip.hide();
                    });
                })

                //baloon hides 
                .on('mouseout', function (d) {
                    var coordinates = [0, 0];
                    coordinates = d3.mouse(this);

                    var y = coordinates[1];
                    if (y > -1) {
                        tool_tip.hide(d);
                    }
                });

            // make lines 

            var polyline = lineG.selectAll("line")
                .data(pie(data), key)

            polyline.enter()
                .append("line").attr("x1", function (d) {
                    return lineArc1.centroid(d)[0];
                })
                .attr("y1", function (d) {
                    return lineArc1.centroid(d)[1];
                })
                .attr("x2", function (d) {
                    return lineArc2.centroid(d)[0];
                })
                .attr("y2", function (d) {
                    return lineArc2.centroid(d)[1];
                })
                .attr("stroke-width", 2);

            polyline.exit()
                .remove();

        }

        change(fetchData(raw_data));
    </script>
</body>

</html>