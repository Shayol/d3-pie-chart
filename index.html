<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <title>D3</title>
</head>
<body>
    

    <script>
        var pieData = [
                {
                    id: 1, parent_id: 0, name: "Health & Fitness", icon: "img/health-fitness.svg", amount: 79
                }, 
                {
                    id: 2, parent_id: 0, name: "Kids", icon: "img/kids.svg", amount: 55
                },
                {
                    id: 3, parent_id: 0, name: "Food & Drinks", icon: "img/food.svg", amount: 17
                },
            ];

    var subcat = [  { id: 4, parent__id: 1, name: "pharmacy", icon:"icon-link", amount: 68},
                    { id: 5, parent__id: 1, name: "medicine", icon:"icon-link", amount: 89},
                    { id: 6, parent__id: 1, name: "health-insurance", icon:"icon-link", amount: 11},
                    { id: 7, parent__id: 1, name: "sports", icon:"icon-link", amount: 290},
                    { id: 8, parent__id: 2, name: "babysitter-daycare", amount: 1},
                    { id: 9, parent__id: 2, name: "kids-activities", icon:"icon-link", amount: 1},
                    { id: 10, parent__id: 2, name: "child-support", icon:"icon-link", amount: 1},
                    { id: 11, parent__id: 2, name: "toys", icon:"icon-link", amount: 2},
                    { name: "restaurants", icon:"icon-link", amount: 68},
                             { name: "coffee-shop", icon:"icon-link", amount: 89},
                             { name: "groceries", icon:"icon-link", amount: 11},
                             { name: "alcohol-bars", icon:"icon-link", amount: 850}
                ]


var width = 540,
    height = 360,
    outerRadius = 113,
    innerRadius = 66.5,
    distanceToLabel = 26;        

var color = d3.scaleOrdinal(["#3f51b5", "#009688", "#039be5", "#d2d588",
                            "#795548", "#ff6f00", "#e91e63", "#607d8b",
                            "#7cb342", "#e53935"]);


var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var g = svg.append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

var pie = d3.pie().value(function (d) {
    return d.amount;
});

var path = d3.arc()
    .outerRadius(outerRadius)
    .innerRadius(innerRadius);

var labelArc = d3.arc()
    .outerRadius(outerRadius + distanceToLabel)
    .innerRadius(outerRadius + distanceToLabel);


var arc = g.selectAll(".arc")
    .data(pie(pieData))
    .enter().append("g")
    .attr("class", "arc");

//add color to slices

var slices = arc.append("path")
    .attr("d", path)
    .attr("fill", function (d, i) { return color(i); })
    .attr("stroke", "#fff");

//add icons

var slicesWithIcons = arc.filter(function(d,i) {
    var angle = d.endAngle - d.startAngle;

    if(angle > 0.38) {    //??find corret number for angle when slice is big enough for icon
        return true;
    }
    return false;
    });

slicesWithIcons.append("svg:image")
    .attr("href", function(d) {return d.data.icon})   
    .attr("transform", function(d){
        var x = path.centroid(d)[0] - 9;
        var y = path.centroid(d)[1] - 9;
        return "translate(" + x + "," + y + ")";
    })
    .attr("width", 16).attr("height", 16); //??calculate correct height


// change opacity of slice on mouseover, change cursor to zoom-in 
slices.on("mouseover", function() {
        d3.select(this).style("opacity", .5)
                       .style("cursor", "zoom-in");
    }).
    on("mouseout", function() {
        d3.select(this).style("opacity", 1)
                       .style("cursor", "pointer");
    });

// add labels

function midAngle(d){
    return d.startAngle + (d.endAngle - d.startAngle)/2;
} 


arc.append("text")
      .attr("transform", function(d) {
        var x = 133 * (midAngle(d) < Math.PI ? 1 : -1);
        var y = labelArc.centroid(d)[1];
        return "translate(" + x + "," + y + ")"; })
      .style("text-anchor", function(d) {
        return midAngle(d) < Math.PI ? "start":"end";
      })
      .text(function(d) { return d.data.name; });



// arc.append("svg:text")
//     .attr("transform", function(d) { 
   
//     d.outerRadius = outerRadius + 80; // Set Outer Coordinate
//     d.innerRadius = outerRadius + 75; // Set Inner Coordinate
//     return "translate(" + path.centroid(d) + ")";
//     })
//     .attr("text-anchor", "end") //center the text on it's origin
//     .style("fill", "Purple")
//     .style("font", "bold 12px Arial")
//     .text(function(d, i) { return d.data.name; });


// var text = g.select(".labels").selectAll("text")
// 		.data(pie(pieData));

// 	text.enter()
// 		.append("text")
// 		.attr("dy", ".35em")
// 		.text(function(d) {
// 			return d.data.name;
// 		});
	
// 	function midAngle(d){
// 		return d.startAngle + (d.endAngle - d.startAngle)/2;
// 	}
    </script>
</body>
</html>