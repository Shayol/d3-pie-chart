<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="d3-tip.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <style>

        body {
            position: relative;
            box-sizing: border-box;
            font-size: 15px;
            font-family: Roboto;
        }


        .baloon-amount {
            color: #444444;
            font-weight: bold;
            font-size: 20px;
        }

        .baloon-transactions {
            color: #039be5;
        }

        .label:hover {
            fill: #039be5;
        }

        .d3-tip {
            color: #999999;
            text-align: center;
            text-align: center;
            position: relative;
            width: 145px;
            height: 97px;
            padding: 14px 0;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.911);
            border: 1px solid #dddddd;
            border-radius: 8px;
            line-height: 1;          
            display: flex;
            flex-direction: column;
            
         }

         text {
             fill: #333333;
         }

         line {
             stroke: #dddddd;
         }
 
    /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {
            content: "";
            display: inline-block;
            position: absolute;
            height: 10px;
            width: 10px;
            top: 100%;
            left: 50%;
            transform: rotate(45deg);
            transform-origin: top right;
            border-right: 1px solid #999999;
            border-bottom: 1px solid #999999;
            background-color: white;
            z-index: 2;
        }

    </style>
    <title>D3</title>
</head>

<body>


    <script>
        var pieData = [
            {
                id: 1, parent_id: 0, name: "Health & Fitness", 
                icon: "img/health-fitness.svg", amount: 79,
                transactions: 24, currency: "€"
            },
            {
                id: 2, parent_id: 0, name: "Kids", 
                icon: "img/kids.svg", amount: 55, 
                transactions: 24, currency: "€"
            },
            {
                id: 3, parent_id: 0, name: "Food & Drinks", 
                icon: "img/food.svg", amount: 17, 
                transactions: 24, currency: "€"
            },
        ];

        var subcat = [{ id: 4, parent__id: 1, name: "pharmacy", icon: "icon-link", amount: 68 },
        { id: 5, parent__id: 1, name: "medicine", icon: "icon-link", amount: 89 },
        { id: 6, parent__id: 1, name: "health-insurance", icon: "icon-link", amount: 11 },
        { id: 7, parent__id: 1, name: "sports", icon: "icon-link", amount: 290 },
        { id: 8, parent__id: 2, name: "babysitter-daycare", amount: 1 },
        { id: 9, parent__id: 2, name: "kids-activities", icon: "icon-link", amount: 1 },
        { id: 10, parent__id: 2, name: "child-support", icon: "icon-link", amount: 1 },
        { id: 11, parent__id: 2, name: "toys", icon: "icon-link", amount: 2 },
        { name: "restaurants", icon: "icon-link", amount: 68 },
        { name: "coffee-shop", icon: "icon-link", amount: 89 },
        { name: "groceries", icon: "icon-link", amount: 11 },
        { name: "alcohol-bars", icon: "icon-link", amount: 850 }
        ]


        var width = 465,
            height = 360,
            outerRadius = 114,
            innerRadius = 66.5,
            labelR = outerRadius + 21;

        var color = d3.scaleOrdinal(["#3f51b5", "#009688", "#039be5", "#d2d588",
            "#795548", "#ff6f00", "#e91e63", "#607d8b",
            "#7cb342", "#e53935"]);


        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        var g = svg.append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var lineG = svg.append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        
        var pie = d3.pie().value(function (d) {
            return d.amount;
        });

        var pieArc = d3.arc()
            .outerRadius(outerRadius)
            .innerRadius(innerRadius);
        
        var lineArc1 = d3.arc()
            .outerRadius(outerRadius +  2)
            .innerRadius(outerRadius + 2);

        var lineArc2 = d3.arc()
            .outerRadius(outerRadius + 19)
            .innerRadius(outerRadius + 19);

        var arcs = g.selectAll(".arc")
            .data(pie(pieData))
            .enter().append("g")
            .attr("class", "arc");


        //add color to slices

        var slices = arcs.append("path")
            .attr("d", pieArc)
            .attr("fill", function (d, i) { return color(i); })
            .attr("stroke", "#fff");

        //add icons

        var slicesWithIcons = arcs.filter(function (d, i) {
            var angle = d.endAngle - d.startAngle;

            if (angle > 0.38) { 
                return true;
            }
            return false;
        });

        var icons = slicesWithIcons.append("svg:image")
            .attr("href", function (d) { return d.data.icon })
            .attr("transform", function (d) {
                var x = pieArc.centroid(d)[0] - 8;
                var y = pieArc.centroid(d)[1] - 8;
                return "translate(" + x + "," + y + ")";
            })
            .attr("width", 16).attr("height", 16);


        // change opacity of slice on mouseover, change cursor to zoom-in 
        slices.on("mouseover", function () {
            d3.select(this).style("opacity", .5)
                .style("cursor", "zoom-in");
        })
        .on("mouseout", function () {
            d3.select(this).style("opacity", 1)
                .style("cursor", "pointer");
        });


        // change opacity of slice when mouse over icon 

        icons.on("mouseover", function () {
            d3.select(this).style("cursor", "zoom-in");
            d3.select(this.parentNode)
            .select("path").style("opacity", .5);
        })
        
        .on("mouseout", function () {
            d3.select(this.parentNode)
            .select("path").style("opacity", .5);
        });

        // add baloons(tooltips) 

        var tool_tip = d3.tip()
                .attr("class", "d3-tip")
                .offset([-12, 0])
                .html(function(d) { return "<div class='baloon-transactions'>" + d.data.transactions + " transactions </div>"
                         + "<div class='baloon-amount'>"
                         + d.data.amount + " " + d.data.currency + "</div>"                         
                         + "<div>" + d.data.percent + "%</div>"; });
                g.call(tool_tip);

        // add labels                         
        var labels = arcs.append("text")
            .attr("transform", function (d) {
                var c = pieArc.centroid(d),
                    x = c[0],
                    y = c[1],
                    // pythagorean theorem for hypotenuse
                    h = Math.sqrt(x * x + y * y);
                return "translate(" + (x / h * labelR) + ',' +
                    (y / h * labelR) + ")";
            })
            .attr("dy", ".35em")
            .attr("text-anchor", function (d) {
                // are we past the center?
                return (d.endAngle + d.startAngle) / 2 > Math.PI ?
                    "end" : "start";
            })
            .text(function (d, i) { return d.data.name; })
            .attr("class", "label")

            // baloons show up on mouseover 
            
            .on('mouseover', tool_tip.show)
            .on('mouseout', tool_tip.hide);
            
            
        // make lines 

        var polyline = lineG.selectAll("line")
            .data(pie(pieData)).enter()
            .append("line").attr("x1", function(d) {
                return lineArc1.centroid(d)[0];
            })
            .attr("y1", function(d) {
                return lineArc1.centroid(d)[1];
            })
            .attr("x2", function(d) {
                return lineArc2.centroid(d)[0];
            })
            .attr("y2", function(d) {
                return lineArc2.centroid(d)[1];
            })
            .attr("stroke-width", 2);

            
    </script>
</body>

</html>